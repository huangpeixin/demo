<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cycling Statistics</title>
   <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>-->
    <script src="./js/chart.js"></script>

</head>
<body>
<div style="width:90%; margin: auto;max-width: 500px;">
    <canvas id="cyclingChart"></canvas>
    <canvas id="areaChart1"></canvas>

</div>

<script>
   
    // Your cycling data here
    // const cyclingData = [];

    fetch('./data/strava-activities.json')
        .then(response =>  response.json())
        .then(data => {
            initCyclingChart(data)
            initAreaChart(data)
        })
    
    function initCyclingChart (cyclingData) {

        // Parse and process data
        const parsedData = cyclingData.map(entry => ({
            date: new Date(entry.start_time),
            distance: entry.distance_raw/1000,
        }));

        // Group data by month
        const groupedData = parsedData.reduce((acc, entry) => {
            const month = entry.date.getMonth() + 1;
            const year = entry.date.getFullYear();
            const day = entry.date.getDate();
            const key = `${year}-${month<10?'0':''}${month}`;

            // init
            acc[key] = acc[key] || { day, totalDistance: 0, dueDistance: 0 };

            // reduce
            acc[key].totalDistance += entry.distance;
            if (day <= new Date().getDate()) {
                acc[key].dueDistance += entry.distance;
            }
            return acc;
        }, {});
        console.info(groupedData)

        // Prepare data for chart  
        const labels = Object.keys(groupedData).map(key => key).sort().slice(-12);
        const barData = labels.map(key => groupedData[key].totalDistance);
        const lineData = labels.map((key, index) => ({
            x: key.substring(5),
            y: groupedData[key].dueDistance,
        }));
        console.info(labels.map(i => i.substring(5)))
        // Create bar and line charts 
        const ctx = document.getElementById('cyclingChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels.map(i => i.substring(5)),
                datasets: [{
                    label: '里程',
                    data: barData,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    barThickness: 10, // 调整条形的宽度
                }, {
                    label: '往月同期',
                    data: lineData,
                    type: 'line',
                    fill: false,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    lineTension: 0.1,
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'category',
                        labels: labels.map(i => i.substring(5)),
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 100, // 设置刻度的步长
                            maxTicksLimit: 100 // 设置最大刻度数量
                        },
                    }
                }
            }
        });
    }

    function initAreaChart(cyclingData) {
        const monthWaveData = {}
        cyclingData.forEach(entry => {
            const date = new Date(entry.start_time)
            console.info(date.getDate())
            const key = `${date.getFullYear()}-${date.getMonth() + 1}`
            monthWaveData[key] = monthWaveData[key] || []
            monthWaveData[key].push({x:Number((date.getDate()+date.getHours()/24).toFixed(1)),y:Number((entry.distance_raw/1000).toFixed(1))})
        })
        console.info(monthWaveData['2023-12'])

        
        // 获取 canvas 元素
        const canvas = document.getElementById('areaChart1');
        const ctx = canvas.getContext('2d');

        // 创建波浪曲线的数据

        // 创建 Chart 实例
        const areaChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Area',
                    borderColor: 'blue',
                    backgroundColor: 'rgba(0, 0, 255, 0.2)',
                    fill: 'origin', // 设置为 'origin' 以填充面积
                    data: monthWaveData['2023-12'],
                    pointRadius: 0, // 隐藏数据点
                    pointHoverRadius: 0, // 鼠标悬停时也隐藏数据点
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                    },
                },
            },
        });
    }
    
</script>
</body>
</html>
